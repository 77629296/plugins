# @amplication/plugin-auth-supertokens

[![NPM Downloads](https://img.shields.io/npm/dt/@amplication/plugin-auth-basic)](https://www.npmjs.com/package/@amplication/plugin-auth-basic)

Use supertokens for authentication in the service generated by Amplication.

## Purpose

This plugin adds the required code to use supertokens for authentication in the service generated by Amplication.

Supertokens is an open source Auth0 alternative. It provides 3 components that need to be setup:
the frontend SDK, the backend SDK, and the SuperTokens core service. For more information on
these, you can check the supertokens docs (https://supertokens.com/docs/emailpassword/introduction#architecture).

Authentication methods are setup with the use of recipes. 

This plugin generates backend code for the email password recipe that allows users to be authenticated with 
their emails and passwords. Support for other recipes will be added.

It updates the following parts:
- Adds the required dependencies to `package.json`.
- Adds the required environment variables to `.env`.
- Adds code for the service based on supertokens backend SDK to the `auth/supertokens` directory.
- Adds some setup in the `connectMicroservices.ts` file.
- Adds a new field to the auth entity, `supertokensId`, to store the user's associated supertokens user ID.
- Modifies the controllers and resolvers of the auth entity to keep the supertokens user ID and other info
like emails and password in sync with the data on the supertokens core when mutations occur.
- It modifies the settings, allowing CORS only from the supertokens configured website domain.
- It disables the graphql playground.

## Configuration

If no configuration is provided the .amplicationrc.json file will use be used as the default values.

An example:

```json
{
    "apiDomain": "http://localhost:3000",
    "appName": "Amplication App",
    "websiteDomain": "http://localhost:3000",
    "websiteBasePath": "/auth",
    "apiBasePath": "/api/auth",
    "connectionUri": "https://try.supertokens.com",
    "apiGatewayPath": "/gateway",
    "emailFieldName": "email",
    "passwordFieldName": "password"
}
```

## Scripts

### `build`

Running `npm run build` will bundle your plugin with Webpack for production.

### `dev`

Running `npm run dev` will watch your plugin's source code and automatically bundle it with every change.

### `test`

Running `npm run test` will run the plugin's test suite.

## Usage

The auth-core plugin must be installed for this plugin to work.

To configure supertokens, set the following environment variables in the generated application:

SUPERTOKENS_CONNECTION_URI - The url link to the supertokens core.

SUPERTOKENS_APP_NAME - The name of the app.

SUPERTOKENS_API_DOMAIN - The API domain.

SUPERTOKENS_WEBSITE_DOMAIN - The website domain.

SUPERTOKENS_API_BASE_PATH - The API server base path for the auth urls.

SUPERTOKENS_WEBSITE_BASE_PATH - The website base path.

SUPERTOKENS_API_KEY - The supertokens API key.

SUPERTOKENS_API_GATEWAY_PATH - The API gateway path.

At the moment, only code for the email password recipe is generated. The fields in the DB that will be used
to store the email and password are the `emailFieldName` and the `passwordFieldName` in the settings.

To maintain a link between the user data stored in the DB and the supertokens core, the supertokens user ID
is stored in the `supertokensId` field of the auth entity.

To maintain this link, the generated code will:
- Create a user on the supertokens core and store that user's data along with the supertokens user ID
in the database, during user creation.
- Prevent updates of the `supertokensId` field to avoid going out of sync with the one stored on the
supertokens core, during updates of the user.
- Delete the supertokens user on the core before deleting the user in the database during deletions.

The exception to this is the automatically generated user that Amplication provides. You have to manually
create the corresponding supertokens user on the supertokens core and store the ID in the user's
`supertokensId` field.
